<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: directives/dfp-ad.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: directives/dfp-ad.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Defines the `dfp-ad` directive.
 * @author Peter Goldsborough &lt;peter@goldsborough.me>
 * @license MIT
 */

// eslint-disable-next-line no-use-before-define
let googletag = googletag || {};
googletag.cmd = googletag.cmd || [];

let angularDfp = (function(module) {
  "use strict";

  /**
   * The controller for the `dfp-ad` directive.
   */
  function dfpAdController() {
    /**
     * The fixed (non-responsive) sizes for the ad slot.
     * @type {Array}
     */
    const sizes = [];

    /**
     * Any `{browserSize, adSizes}` objects to create responsive mappings.
     * @type {Array}
     */
    const responsiveMapping = [];

    /**
     * Any key/value targeting objects.
     * @type {Array}
     */
    const targetings = [];

    /**
     * Any category exclusion labels.
     * @type {Array}
     */
    const exclusions = [];

    /**
     * Any additional scripts to execute for the slot.
     * @type {Array}
     */
    const scripts = [];

    /**
     * Tests if the state of the directive is valid and complete.
     * @return {Boolean} True if the ad slot may be created, else false.
     */
    this.isValid = function() {
      if (sizes.length === 0) return false;
      if (!this.adUnit) return false;
      return true;
    };

    /**
     * Returns the public state of the controller for use by the directive.
     * @return {object} An object of all properties the directive will
     *                  need to create an ad slot.
     */
    this.getState = function() {
      console.assert(this.isValid());
      return Object.freeze({
        sizes: sizes,
        responsiveMapping: responsiveMapping,
        targeting: targetings,
        exclusions: exclusions,
        adUnit: this.adUnit,
        forceSafeFrame: this.forceSafeFrame,
        clickUrl: this.clickUrl,
        refresh: this.refresh,
        scripts: scripts,
        collapseIfEmpty: this.collapseIfEmpty
      });
    };

    /**
     * Registers a (fixed) size for the ad slot.
     *
     * @param {Array} size A [width, height] array.
     * @see [Google DFP Support]{@link https://support.google.com/dfp_premium/answer/1697712?hl=en}
     * @see [GPT Reference]{@link https://developers.google.com/doubleclick-gpt/reference#googletag.defineSlot}
     */
    this.addSize = function(size) {
      sizes.push(size);
    };

    /**
     * Registers a responsive mapping for the ad slot.
     * @param {object} mapping A `{browserSize, adSizes}` mapping.
     * @see [Google DFP Support]{@link https://support.google.com/dfp_premium/answer/3423562?hl=en}
     * @see [GPT Reference]{@link https://developers.google.com/doubleclick-gpt/reference#googletag.SizeMappingBuilder}
     */
    this.addResponsiveMapping = function(mapping) {
      responsiveMapping.push(mapping);
    };

    /**
     * Registers a targeting object for the ad slot.
     * @param {object} targeting A {browserSize, adSizes} object.
     * @see [Google DFP Support]{@link https://support.google.com/dfp_premium/answer/177383?hl=en}
     * @see [GPT Reference]{@link https://developers.google.com/doubleclick-gpt/reference#googletag.PassbackSlot_setTargeting}
     */
    this.addTargeting = function(targeting) {
      targetings.push(targeting);
    };

    /**
     * Registers a category exclusion for the slot.
     * @param {string} exclusion The category exclusion label.
     * @see [Google Developer Support]{@link https://support.google.com/dfp_premium/answer/3238504?hl=en&amp;visit_id=1-636115253122574896-2326272409&amp;rd=1}
     * @see [GPT Reference] {@link https://developers.google.com/doubleclick-gpt/reference#googletag.PubAdsService_setCategoryExclusion}
     */
    this.addExclusion = function(exclusion) {
      exclusions.push(exclusion);
    };

    /**
     * Registers a script for the slot.
     *
     * Scripts can be run during ad slot definition and before the actual ad
     * call, to perform any auxiliary configuration taks not handled by our
     * interface.
     *
     * @param {string} script The script string to be evaluated.
     */
    this.addScript = function(script) {
      scripts.push(script);
    };
  }

  /**
   * The directive for the `dfp-ad` tag.
   *
   * This is the primary directive used for defining ad slots. All other
   * directives, except `dfp-video`, are nested under this slot. It is
   * standalone except for the necessity of (at least) one nested `dfp-size`
   * directive.
   *
   * @param {object} scope          The Angular element scope.
   * @param {object} element        The jQuery/jQlite element of the directive.
   * @param {object} attributes     The attributes defined on the element.
   * @param  {function} $injector {@link http://docs.angularjs.org/api/ng.$injector}
   */
  function dfpAdDirective(scope, element, attributes, $injector) {
    let $window = $injector.get('$window');
    const doubleClick = $injector.get('doubleClick');
    const dfpIDGenerator = $injector.get('dfpIDGenerator');
    const dfpRefresh = $injector.get('dfpRefresh');
    const responsiveResize = $injector.get('responsiveResize');

    const ad = scope.controller.getState();

    // Turn the window into a jQuery/jQlite object
    // eslint-disable-next-line no-undef
    $window = angular.element($window);

    // Unpack jQuery object
    element = element[0];

      // Generate an ID or check for uniqueness of an existing one
    dfpIDGenerator(element);

    /**
     * Handles the responsive mapping (`sizeMapping`) building.
     * @param {googletag.Slot} slot The ad slot.
     */
    function addResponsiveMapping(slot) {
      if (ad.responsiveMapping.length === 0) return;

      const sizeMapping = googletag.sizeMapping();

      ad.responsiveMapping.forEach(function(mapping) {
        sizeMapping.addSize(mapping.browserSize, mapping.adSizes);
      });

      slot.defineSizeMapping(sizeMapping.build());
    }

    /**
     * Defines the ad slot, aggregating all nested directives.
     *
     * This function combines all the properties added by nested directives.
     * Recall, for this, that angular executes controllers on the way down the
     * DOM and directives on the way up. As such, this directive is executed
     * after all nested directives were been invoked (adding properties such as
     * sizes, responsive mappings or key/value pairs to the controller). The
     * full ad slot definition can then be sent into the `googletag` command
     * queue to fetch an ad from the DoubleClick ad network.
     */
    function defineSlot() {
      const slot = googletag.defineSlot(ad.adUnit, ad.sizes, element.id);

      if (ad.forceSafeFrame !== undefined) {
        slot.setForceSafeFrame(true);
      }

      if (ad.clickUrl) {
        slot.setClickUrl(ad.clickUrl);
      }

      if (ad.collapseIfEmpty !== undefined) {
        slot.setCollapseEmptyDiv(true, true);
      }

      addResponsiveMapping(slot);

      ad.targeting.forEach(function(targeting) {
        slot.setTargeting(targeting.key, targeting.values);
      });

      ad.exclusions.forEach(function(exclusion) {
        slot.setCategoryExclusion(exclusion);
      });

      ad.scripts.forEach(function(script) {
        script(slot);
      });

      slot.addService(googletag.pubads());

      // When initialLoad is disabled, display()
      // will only register the slot as ready, but not actually
      // fetch an ad for it yet. This is done via refresh().
      googletag.display(element.id);

      // Send to the refresh proxy
      dfpRefresh(slot, ad.refresh, function() {
        if (ad.responsiveMapping.length > 0) {
          $window.on('resize', responsiveResize(slot));
        }
      });
    }

    // Push the ad slot definition into the command queue.
    doubleClick.then(defineSlot);
  }

  module.directive('dfpAd', ['$injector', function($injector) {
    return {
      restrict: 'AE',
      controller: dfpAdController,
      bindToController: true,
      link: function() { dfpAdDirective.apply(arguments.concat($injector)); },
      scope: {
        adUnit: '@',
        clickUrl: '@',
        forceSafeFrame: '@',
        refresh: '@',
        collapseIfEmpty: '@'
      }
    };
  }
  ]);

// eslint-disable-next-line
})(angularDfp || angular.module('angular-angularDfp'));
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Sat Oct 08 2016 14:27:04 GMT+0100 (BST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
